<script src='../util.js'></script>
<script>
var phase = location.hash;

var lastPendingState = '',
    lastActiveState = '',
    receivedMessageFromPort = '';

if (phase != '#activate') {
  assert('navigator.serviceWorker');
  // FIXME: .pending name is changing, for now I'm just commenting out
  // all .pending related tests.
  // assert('navigator.serviceWorker.pending == null');
  assert('navigator.serviceWorker.current == null');
} else {
  assert('navigator.serviceWorker');
  assert('navigator.serviceWorker.current');
  assert('navigator.serviceWorker.current.state == "active"');
}

navigator.serviceWorker.onpendingchange = function() {
  if (navigator.serviceWorker.pending) {
    assert('navigator.serviceWorker.pending.state == "parsed"');

    sendMessagePortToServiceWorker(
      navigator.serviceWorker.pending,
      'inscope doc (via pending)',
      function (e) { receivedMessageFromPort = e.data; });

    navigator.serviceWorker.pending.onstatechange = function() {
      switch (navigator.serviceWorker.pending.state) {
        case 'installing':
          assert('lastPendingState == "parsed"');
          break;
        case 'installed':
          assert('lastPendingState == "installing"');
          break;
        case 'activating':
          assert('lastPendingState == "installed"');
          break;
        case 'active':
          assert('lastPendingState == "activating"');
          break;
      }
      lastPendingState = navigator.serviceWorker.pending.state;
      if (lastPendingState == 'active')
        done();
    };
  }
}

if (navigator.serviceWorker.current) {
  sendMessagePortToServiceWorker(
    navigator.serviceWorker.current,
    'inscope doc (via current)',
    function (e) {
      receivedMessageFromPort = e.data;
      done();
    });
}

function onTestFinished() {
  if (phase != '#activate') {
    test_header('Registration finished.');
    // No current change happens during the doc's lifetime without .replace().
    assert('currentChangeCount == 0');
    assert('currentStateChangeCount == 0');
    // Likewise we'll only see installing and installed statechange.
//    assert('pendingChangeCount == 1');
//    assert('pendingStateChangeCount == 2');
//    assert('lastPendingState == "active"');
//    assert('receivedMessageFromPort == "Ack for: inscope doc (via pending)"');

    test_header('Reloading the doc to test in-scope with .current');
    document.location.href = document.location + '#activate';
    document.location.reload();
  } else {
    test_header('Activation finished.');
    assert('currentChangeCount == 0');
    assert('currentStateChangeCount == 0');
//    assert('pendingChangeCount == 0');
//    assert('pendingStateChangeCount == 0');
    assert('receivedMessageFromPort == "Ack for: inscope doc (via current)"');
  }
}
</script>
