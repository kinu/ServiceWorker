<script src='../util.js'></script>
<script>
var serviceWorker = null,
    serviceWorkerStateChangeCount = 0,
    lastServiceWorkerState = '',
    receivedMessageFromPort = '';

assert('navigator.serviceWorker');
assert('navigator.serviceWorker.register');
assert('navigator.serviceWorker.unregister');

// This always tests fresh registration, so unregister it first.
navigator.serviceWorker.unregister('/in-scope/*').then(
function() {
  return navigator.serviceWorker.register(
    '../service-worker.js', {scope:'/in-scope/*'});
}).then(onRegister, onRegister).catch(errorHandler);

function onRegister(sw) {
  serviceWorker = sw;
  test_header('Registration returned ' + serviceWorker);
  lastServiceWorkerState = serviceWorker.state;

  sendMessagePortToServiceWorker(
    sw, 'registering doc',
    function (e) {
      receivedMessageFromPort = e.data;
      if (lastServiceWorkerState == 'active')
        done();
    });

  sw.onstatechange = function() {
    ++serviceWorkerStateChangeCount;
    switch (sw.state) {
      case 'installing':
        assert('lastServiceWorkerState == "parsed"');
        break;
      case 'installed':
        assert('lastServiceWorkerState == "installing"');
        break;
      case 'activating':
        assert('lastServiceWorkerState == "installed"');
        break;
      case 'active':
        assert('lastServiceWorkerState == "activating"');
        break;
    }
    lastServiceWorkerState = sw.state;
    if (lastServiceWorkerState == 'active' && receivedMessageFromPort)
      done();
  };
}

function onTestFinished() {
  test_header('Registration finished.');
  assert('serviceWorkerStateChangeCount == 3');
  assert('lastServiceWorkerState == "active"');
  assert('receivedMessageFromPort == "Ack for: registering doc"');

  // This document is out-of-scope, so we should see no current change events.
  assert('currentStateChangeCount == 0');
}
</script>
